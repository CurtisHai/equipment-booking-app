{% extends 'bookings/base.html' %}

{% block content %}
<div class="container mt-5">
    <!-- Display different title based on whether the user is a superuser -->
    <h2 class="text-center mb-4">
        {% if is_superuser %}
            All Upcoming Bookings
        {% else %}
            Your Upcoming Bookings
        {% endif %}
    </h2>

    <!-- Responsive table for displaying upcoming bookings -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover w-100" style="background-color: #ffffff; width: 100%;">
            <thead style="background-color: #BE02F8; color: #ffffff; font-size: 1.25rem; text-align: center;">
                <tr class="text-center">
                    {% if is_superuser %}
                        <th>User</th> 
                    {% endif %}
                    <th>Item</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Actions</th> 
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr class="text-center">
                    {% if is_superuser %}
                        <td>{{ booking.user.username }}</td> <!-- Display the username for superusers -->
                    {% endif %}
                    <td>{{ booking.equipment.name }}</td> 
                    <td>{{ booking.start_time|date:"d M Y H:i" }}</td> 
                    <td>{{ booking.end_time|date:"d M Y H:i" }}</td>
                    <td>
                        <!-- Allow superusers to edit any booking, and regular users to edit only future bookings -->
                        {% if is_superuser %}
                            <form action="{% url 'edit_booking' booking.id %}" method="get" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-sm">Edit</button>
                            </form>
                        {% elif booking.start_time > current_time and booking.user == request.user %}
                            <form action="{% url 'edit_booking' booking.id %}" method="get" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-sm">Edit</button>
                            </form>
                        {% endif %}
                        
                        <!-- Delete option for superusers only -->
                        {% if is_superuser %}
                        <form method="POST" action="{% url 'delete_booking' booking.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete(this)">Delete</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <!-- Display this row if no upcoming bookings are available -->
                <tr>
                    <td colspan="{% if is_superuser %}5{% else %}4{% endif %}" class="text-center">No upcoming bookings available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Show previous bookings section if any exist -->
    {% if previous_bookings %}
    <h2 class="text-center mb-4 mt-5">Previous Bookings</h2>
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover w-100" style="background-color: #ffffff; width: 100%;">
            <thead style="background-color: #BE02F8; color: #ffffff; font-size: 1.25rem; text-align: center;"> <!-- Table header for previous bookings -->
                <tr class="text-center">
                    {% if is_superuser %}
                        <th>User</th> <!-- Display user for superusers -->
                    {% endif %}
                    <th>Item</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in previous_bookings %}
                <tr class="text-center">
                    {% if is_superuser %}
                        <td>{{ booking.user.username }}</td>
                    {% endif %}
                    <td>{{ booking.equipment.name }}</td>
                    <td>{{ booking.start_time|date:"d M Y H:i" }}</td>
                    <td>{{ booking.end_time|date:"d M Y H:i" }}</td>
                </tr>
                {% empty %}
                <!-- Display this row if no previous bookings are available -->
                <tr>
                    <td colspan="{% if is_superuser %}4{% else %}3{% endif %}" class="text-center">No previous bookings available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Button to view all previous bookings -->
    <div class="text-center mt-4 mb-5"> <!-- Add space between content and footer -->
        <form action="{% url 'previous_bookings' %}" method="get" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">View All Previous Bookings</button>
        </form>
    </div>

    <!-- JavaScript function to confirm the delete action -->
    <script>
    function confirmDelete(button) {
        if (confirm("Are you sure you want to delete this booking?")) {
            button.closest('form').submit();
        }
    }
    </script>
</div>
{% endblock %}
